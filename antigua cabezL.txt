<?php
ob_start();

if (!isset($_SESSION['version'])) {
    $_SESSION['version'] = date("YmdHms");
}

$visibletickets    = isset($_SESSION['visibletickets'])    ? $_SESSION['visibletickets']    : 0;
$visiblewiki       = isset($_SESSION['visiblewiki'])       ? $_SESSION['visiblewiki']       : 0;
$visiblefortimail  = isset($_SESSION['visiblefortimail'])  ? $_SESSION['visiblefortimail']  : 0;
$visibleusuarios   = isset($_SESSION['visibleusuarios'])   ? $_SESSION['visibleusuarios']   : 0;
$visiblecrm        = isset($_SESSION['visiblecrm'])        ? $_SESSION['visiblecrm']        : 0;
$visiblermas       = isset($_SESSION['visiblermas'])       ? $_SESSION['visiblermas']       : 0;
$visibleordenes    = isset($_SESSION['visibleordenes'])    ? $_SESSION['visibleordenes']    : 0;
$visiblenubes      = isset($_SESSION['visiblenubes'])      ? $_SESSION['visiblenubes']      : 0;

// Mapeo de permisos: clave = id del permiso en la API (como cadena)
// y valor = información del menú
$permissionsMapping = array(
    '1' => array(
        'name'    => 'tickets',
        'visible' => $visibletickets,
        'default' => 'default_tickets.png',
        'file'    => 'tickets.php',
        'id'      => 'nav-tickets'
    ),
    '2' => array(
        'name'    => 'wiki',
        'visible' => $visiblewiki,
        'default' => 'default_wiki.png',
        'file'    => 'wiki.php',
        'id'      => 'nav-wiki'
    ),
    '3' => array(
        'name'    => 'fortimail',
        'visible' => $visiblefortimail,
        'default' => 'default_fortimail.png',
        'file'    => 'fortimail.php',
        'id'      => 'nav-fortimail'
    ),
    '4' => array(
        'name'    => 'usuarios',
        'visible' => $visibleusuarios,
        'default' => 'default_usuarios.png',
        'file'    => 'usuarios.php',
        'id'      => 'nav-usuarios'
    ),
    '5' => array(
        'name'    => 'crm',
        'visible' => $visiblecrm,
        'default' => 'default_crm.png',
        'file'    => 'crm.php',
        'id'      => 'nav-crm'
    ),
    '6' => array(
        'name'    => 'rmas',
        'visible' => $visiblermas,
        'default' => 'default_rmas.png',
        'file'    => 'rmas.php',
        'id'      => 'nav-rmas'
    ),
    '7' => array(
        'name'    => 'ordenes',
        'visible' => $visibleordenes,
        'default' => 'default_ordenes.png',
        'file'    => 'ordenes.php',
    ),
    '8' => array(
        'name'    => 'nubes',
        'visible' => $visiblenubes,
        'default' => 'default_nubes.png',
        'file'    => 'nubes.php',
        'id'      => 'nav-nubes'
    )
  );
    $orderedItems = array();
foreach ($permissionsMapping as $permisoId => $data) {
    if ($data['visible'] == 1) {
        // Si existe un valor de orden en la sesión, lo usamos; de lo contrario, asignamos un número alto para que aparezca al final.
        $order = isset($_SESSION['orden'][$permisoId]) ? $_SESSION['orden'][$permisoId] : 999;
        $data['order'] = $order;
        $orderedItems[$permisoId] = $data;
    }
}
// Ordenar el arreglo por el campo 'order'
uasort($orderedItems, function($a, $b) {
    return $a['order'] - $b['order'];
});
?>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
  
    <link rel="icon" href="../images/logo.png?v=<?php echo $_SESSION['version'];?>" type="image">
    <link rel="stylesheet" href="../css/styles.css?v=<?php echo $_SESSION['version'];?>">       
    <link rel="stylesheet" href="../css2/style.css?v=<?php echo $_SESSION['version'];?>"> 
    <script src="../js/funciones.js?v=<?php echo $_SESSION['version'];?>"></script>
    <script src="../js/scripts.js?v=<?php echo $_SESSION['version'];?>"></script>
    <script src="../js/zonashorarias.js?v=<?php echo $_SESSION['version'];?>"></script>
    <!--<script src="../js2/jquery.min.js"></script>-->
    <!--<script src="../js2/popper.js"></script>
    <script src="../js2/modal.js"></script>
    <script src="../js2/util.js"></script>
    <script src="../js2/bootstrap.min.js"></script>-->

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700,800,900" >
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.1.0/css/buttons.dataTables.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/2.1.8/css/dataTables.dataTables.css" />
    <link rel='stylesheet' href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' >

    <script src="https://cdn.jsdelivr.net/npm/es6-promise/dist/es6-promise.auto.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script> 
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/imagemapster/1.8.0/jquery.imagemapster.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.28.14/js/jquery.tablesorter.min.js"></script>
    <script src="https://cdn.datatables.net/2.1.8/js/dataTables.js"></script>
    <script src="https://cdn.datatables.net/scroller/2.4.3/js/dataTables.scroller.js"></script>
    <script src="https://cdn.datatables.net/scroller/2.4.3/js/scroller.bootstrap4.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.1.0/js/dataTables.buttons.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.1.0/js/buttons.dataTables.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.1.2/js/buttons.html5.min.js"></script>

    
    <!-- Moment.js: -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js" ></script>
    <!-- Locales for moment.js-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment-with-locales.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.45/moment-timezone.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.45/moment-timezone-with-data.js"></script>
    <script src="https://cdn.datatables.net/plug-ins/1.10.15/sorting/datetime-moment.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.3/xlsx.full.min.js"></script>
    <script src="https://cdn.datatables.net/plug-ins/2.1.2/api/page.jumpToData().js"></script>


    <script src="https://kit.fontawesome.com/e0a48b22a0.js" crossorigin="anonymous"></script>

    <script src="https://cdn.datatables.net/responsive/3.0.2/js/dataTables.responsive.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/3.0.2/css/responsive.dataTables.min.css">

     <!-- ContextMenu.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.9.2/jquery.contextMenu.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.9.2/jquery.contextMenu.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.9.2/jquery.ui.position.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.9.2/jquery.ui.position.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.9.2/jquery.contextMenu.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.9.2/jquery.contextMenu.min.css"/>


    <script src="https://cdn.datatables.net/select/2.1.0/js/dataTables.select.js"></script>
    <script src="https://cdn.datatables.net/select/2.1.0/js/select.dataTables.js"></script>

    <!--<link rel="stylesheet" href="https://cdn.datatables.net/2.1.8/css/dataTables.dataTables.css"/>-->
    <link rel="stylesheet" href="https://cdn.datatables.net/select/2.1.0/css/select.dataTables.css"/>

    <!--<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Josefin+Sans:300,400|Roboto:300,400,500">


    
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    
   -->
    <title>Lucerna - <?php echo $page ?></title>
   
</head>

<body>
    <div class="wrapper d-flex align-items-stretch">
        <nav id="sidebar" class="active" style="min-height: 100vh;">
            <h1>
                <a class="logo">
                    <img src="../images/logo.png" width="44" height="44" alt="logo-nav-terminales-fichaje">
                </a>                
            </h1>
            <ul class="list-unstyled components mb-5">
                <?php
                // Función para renderizar el icono: si existe en sesión se usa, sino se usa el default.
                function renderIcon($key, $default) {
                    if (isset($_SESSION['iconos'][$key]) && !empty($_SESSION['iconos'][$key])) {
                        $icon = $_SESSION['iconos'][$key];
                        if (strpos($icon, 'data:') === 0) {
                            $src = $icon;
                        } else {
                            $src = 'data:image/png;base64,' . $icon;
                        }
                        return '<img src="' . $src . '" alt="' . ucfirst($key) . '" width="50" height="50" style="vertical-align: middle; margin-right:5px;"> ';
                    } else {
                        return '<img src="../images/' . $default . '" width="50" height="50" style="vertical-align: middle; margin-right:5px;"> ';
                    }
                }
                // Recorrer el arreglo ordenado y pintar cada elemento
                foreach ($orderedItems as $permisoId => $item): ?>
                    <li>
                        <a id="<?= $item['id']; ?>" href="#" onclick="return cargarContenido('<?= $item['file']; ?>');" title="<?= ucfirst($item['name']); ?>">
                            <span><?= renderIcon($item['name'], $item['default']); ?></span>
                            <?= ucfirst($item['name']); ?>
                        </a>
                    </li>
                <?php endforeach; ?>
            </ul>
            <div class="footer">
                <p>&copy;<script>document.write(new Date().getFullYear());</script> Todos los derechos registrados | TerminalesDeFichaje</p>
            </div>
        </nav>
    </div>
</body>

</html>






_______________________________________________________________________________
<?php 
ob_start();

if(!isset($_SESSION['version'])){
    $_SESSION['version'] =date("YmdHms");
}
$visibletickets    = isset($_SESSION['visibletickets'])    ? $_SESSION['visibletickets']    : 0;
$visiblewiki       = isset($_SESSION['visiblewiki'])       ? $_SESSION['visiblewiki']       : 0;
$visiblefortimail  = isset($_SESSION['visiblefortimail'])  ? $_SESSION['visiblefortimail']  : 0;
$visibleusuarios   = isset($_SESSION['visibleusuarios'])   ? $_SESSION['visibleusuarios']   : 0;
$visiblecrm        = isset($_SESSION['visiblecrm'])        ? $_SESSION['visiblecrm']        : 0;
$visiblermas       = isset($_SESSION['visiblermas'])       ? $_SESSION['visiblermas']       : 0;
$visibleordenes    = isset($_SESSION['visibleordenes'])    ? $_SESSION['visibleordenes']    : 0;
$visiblenubes      = isset($_SESSION['visiblenubes'])      ? $_SESSION['visiblenubes']    : 0;
?>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
  
    <link rel="icon" href="../images/logo.png?v=<?php echo $_SESSION['version'];?>" type="image">
    <link rel="stylesheet" href="../css/styles.css?v=<?php echo $_SESSION['version'];?>">       
    <link rel="stylesheet" href="../css2/style.css?v=<?php echo $_SESSION['version'];?>"> 
    <script src="../js/funciones.js?v=<?php echo $_SESSION['version'];?>"></script>
    <script src="../js/scripts.js?v=<?php echo $_SESSION['version'];?>"></script>
    <script src="../js/zonashorarias.js?v=<?php echo $_SESSION['version'];?>"></script>
    <!--<script src="../js2/jquery.min.js"></script>-->
    <!--<script src="../js2/popper.js"></script>
    <script src="../js2/modal.js"></script>
    <script src="../js2/util.js"></script>
    <script src="../js2/bootstrap.min.js"></script>-->

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700,800,900" >
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.1.0/css/buttons.dataTables.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/2.1.8/css/dataTables.dataTables.css" />
    <link rel='stylesheet' href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' >

    <script src="https://cdn.jsdelivr.net/npm/es6-promise/dist/es6-promise.auto.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script> 
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/imagemapster/1.8.0/jquery.imagemapster.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.28.14/js/jquery.tablesorter.min.js"></script>
    <script src="https://cdn.datatables.net/2.1.8/js/dataTables.js"></script>
    <script src="https://cdn.datatables.net/scroller/2.4.3/js/dataTables.scroller.js"></script>
    <script src="https://cdn.datatables.net/scroller/2.4.3/js/scroller.bootstrap4.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.1.0/js/dataTables.buttons.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.1.0/js/buttons.dataTables.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.1.2/js/buttons.html5.min.js"></script>

    
    <!-- Moment.js: -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js" ></script>
    <!-- Locales for moment.js-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment-with-locales.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.45/moment-timezone.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.45/moment-timezone-with-data.js"></script>
    <script src="https://cdn.datatables.net/plug-ins/1.10.15/sorting/datetime-moment.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.3/xlsx.full.min.js"></script>
    <script src="https://cdn.datatables.net/plug-ins/2.1.2/api/page.jumpToData().js"></script>


    <script src="https://kit.fontawesome.com/e0a48b22a0.js" crossorigin="anonymous"></script>

    <script src="https://cdn.datatables.net/responsive/3.0.2/js/dataTables.responsive.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/3.0.2/css/responsive.dataTables.min.css">

     <!-- ContextMenu.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.9.2/jquery.contextMenu.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.9.2/jquery.contextMenu.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.9.2/jquery.ui.position.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.9.2/jquery.ui.position.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.9.2/jquery.contextMenu.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.9.2/jquery.contextMenu.min.css"/>


    <script src="https://cdn.datatables.net/select/2.1.0/js/dataTables.select.js"></script>
    <script src="https://cdn.datatables.net/select/2.1.0/js/select.dataTables.js"></script>

    <!--<link rel="stylesheet" href="https://cdn.datatables.net/2.1.8/css/dataTables.dataTables.css"/>-->
    <link rel="stylesheet" href="https://cdn.datatables.net/select/2.1.0/css/select.dataTables.css"/>

    <!--<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Josefin+Sans:300,400|Roboto:300,400,500">


    
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    
   -->
    <title>Lucerna - <?php echo $page ?></title>
   
</head>

<body>
    <div class="wrapper d-flex align-items-stretch">
        <nav id="sidebar" class="active" style="min-height: 100vh;">
            <h1>
                <a class="logo">
                    <img src="../images/logo.png" width="44" height="44" alt="logo-nav-terminales-fichaje">
                </a>                
            </h1>
            <ul class="list-unstyled components mb-5">
                <?php
                // Función para devolver el <img> del icono: usa el icono de sesión si existe o uno predeterminado
                function renderIcon($key, $default) {
                    if (isset($_SESSION['iconos'][$key]) && !empty($_SESSION['iconos'][$key])) {
                        $icon = $_SESSION['iconos'][$key];
                        if (strpos($icon, 'data:') === 0) {
                            $src = $icon;
                        } else {
                            $src = 'data:image/png;base64,' . $icon;
                        }
                        return '<img src="' . $src . '" alt="' . ucfirst($key) . '" width="50" height="50" style="vertical-align: middle; margin-right:5px;"> ';
                    } else {
                        return '<img src="../images/icon.png"'.'" width="50" height="50" style="vertical-align: middle; margin-right:5px;"> ';
                    }
                }
                
                ?>
                <li class="<?= ($page == 'tickets') ? 'active' : ''; ?>" <?= ($visibletickets == 0) ? 'style="display:none;"' : ''; ?>>
                    <a id="nav-tickets" href="#" onclick="return cargarContenido('tickets.php');" title="tickets">
                        <span class="position-relative">
                        <?= renderIcon('tickets','default_tickets.png'); ?>
                        <span id="misTicketsBadge" class="badge badge-danger badge-circle position-absolute">0</span>
                        </span>
                         Tickets
                    </a>
                </li>
                <li class="<?= ($page == 'wiki') ? 'active' : ''; ?>" <?= ($visiblewiki == 0) ? 'style="display:none;"' : ''; ?>>
                    <a id="nav-wiki" href="#" onclick="return cargarContenido('wiki.php');" title="Wiki">
                    <span><?= renderIcon('wiki','default_wiki.png'); ?></span>Wiki
                    </a>
                </li>
                <li class="<?= ($page == 'fortimail') ? 'active' : ''; ?>" <?= ($visiblefortimail == 0) ? 'style="display:none;"' : ''; ?>>
                    <a id="nav-fortimail" href="#" onclick="return cargarContenido('fortimail.php');" title="Fortimail">
                    <span><?= renderIcon('fortimail','default_fortimail.png'); ?></span>Fortimail
                    </a>
                </li>
                <li class="<?= ($page == 'usuarios') ? 'active' : ''; ?>" <?= ($visibleusuarios == 0) ? 'style="display:none;"' : ''; ?>>
                    <a id="nav-usuarios" href="#" onclick="return cargarContenido('usuarios.php');" title="Usuarios">
                    <span><?= renderIcon('usuarios','default_usuarios.png'); ?></span>Usuarios
                    </a>
                </li>
                <li class="<?= ($page == 'crm') ? 'active' : ''; ?>" <?= ($visiblecrm == 0) ? 'style="display:none;"' : ''; ?>>
                    <a id="nav-crm" href="#" onclick="return cargarContenido('crm.php');" title="CRM">
                    <span><?= renderIcon('crm','default_crm.png'); ?></span>CRM
                    </a>
                </li>
                <li class="<?= ($page == 'rmas') ? 'active' : ''; ?>" <?= ($visiblermas == 0) ? 'style="display:none;"' : ''; ?>>
                    <a id="nav-rmas" href="#" onclick="return cargarContenido('rmas.php');" title="RMAS">
                    <span><?= renderIcon('rmas','default_rmas.png'); ?></span>RMAS
                    </a>
                </li>
                <li class="<?= ($page == 'ordenes') ? 'active' : ''; ?>" <?= ($visibleordenes == 0) ? 'style="display:none;"' : ''; ?>>
                    <a id="nav-ordenes" href="#" onclick="return cargarContenido('ordenes.php');" title="Ordenes">
                    <span><?= renderIcon('ordenes','default_ordenes.png'); ?></span>Ordenes
                    </a>
                </li>
                <li class="<?= ($page == 'nubes') ? 'active' : ''; ?>" <?= ($visiblenubes == 0) ? 'style="display:none;"' : ''; ?>>
                    <a id="nav-nubes" href="#" onclick="return cargarContenido('nubes.php');" title="Nubes">
                    <span><?= renderIcon('nubes','default_nubes.png'); ?></span>Nubes
                    </a>
                </li>

            </ul>
            <div class="footer">
                <p>&copy;<script>document.write(new Date().getFullYear());</script> Todos los derechos registrados | TerminalesDeFichaje</p>
            </div>
        </nav>
    </div>
</body>

</html>